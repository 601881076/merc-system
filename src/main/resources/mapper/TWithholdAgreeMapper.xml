<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xhnj.mapper.TWithholdAgreeMapper">

    <sql id="withholdAgreeSql1">
        id,
        system_type,
        source_type,
        deal_flag,
        bank_code,
        bank_name,
        system_batch,
        fin_label_cd,
        project_no,
        agreement_id,
        bizserial_no,
        mobile_no,
        card_no,
        customer_name,
        cert_type,
        cert_no,
        check_no,
        send_no,
        own_spec,
        re_own_spec,
        status,
        is_send,
        bank_ret_code,
        reason,
        CONVERT(single_max/100, decimal(15,2)) AS "single_max",
        day_max,
        month_max,
        CONVERT(sum_max/100, decimal(15,2)) AS "sum_max" ,
        start_date,
        end_date
    </sql>

    <insert id="addBatch" parameterType="list">
        INSERT INTO t_withhold_agree
        (source_type,           deal_flag,                 bank_code,                bank_name,system_batch,                 project_no,
        agreement_id,           bizserial_no,              mobile_no,                   card_no,                customer_name,
        cert_type,                cert_no,                     check_no,               send_no,                    own_spec
        )
        VALUES
        <foreach collection ="list" item="item" index= "index" separator =",">
            (
            #{item.sourceType, jdbcType=BIGINT},
            #{item.dealFlag, jdbcType=BIGINT},
            #{item.bankCode,jdbcType=VARCHAR},
            (select bank_name from t_banks where inter_bank_no = #{item.bankCode,jdbcType=VARCHAR}),
            #{item.systemBatch,jdbcType=VARCHAR},
            #{item.projectNo,jdbcType=VARCHAR},
            #{item.agreementId,jdbcType=VARCHAR},
            #{item.bizserialNo,jdbcType=VARCHAR},
            #{item.mobileNo,jdbcType=VARCHAR},
            #{item.cardNo,jdbcType=VARCHAR},
            #{item.customerName,jdbcType=VARCHAR},
            #{item.certType,jdbcType=VARCHAR},
            #{item.certNo,jdbcType=VARCHAR},
            #{item.checkNo,jdbcType=VARCHAR},
            #{item.sendNo,jdbcType=VARCHAR},
            #{item.ownSpec,jdbcType=VARCHAR}
            )
        </foreach >
    </insert>

    <select id="listPageByBatchNo" resultType="com.xhnj.model.TWithholdAgree">
        SELECT
            <include refid="withholdAgreeSql1" />
        FROM t_withhold_agree
        WHERE system_batch = #{batchNo,jdbcType=VARCHAR}
    </select>

    <select id="getByCardNo" resultType="com.xhnj.model.TWithholdAgree">
        SELECT
          source_type,
          status
        FROM t_withhold_agree
        WHERE card_no IN
        <foreach  collection="cardNoList" item="req" open="(" close=")" separator=" or ">
             #{req,jdbcType=VARCHAR}
        </foreach>
        AND deal_flag = #{dealFlag,jdbcType=INTEGER}
    </select>

    <sql id="withholdAgreeSql">
        agree.id		,
        agree.system_type	,
        agree.source_type	,
/*        agree.deal_flag	,*/
        agree.bank_code	,
        agree.bank_name	,
        agree.system_batch	,
        agree.fin_label_cd	,
        agree.project_no	,
        agree.agreement_id	,
        agree.bizserial_no	,
        agree.mobile_no	,
        agree.card_no		,
        agree.customer_name 	,
        agree.cert_type	,
        agree.cert_no		,
        agree.check_no	,
        agree.send_no		,
        agree.own_spec	,
        agree.re_own_spec	,
        agree.status		,
        agree.is_send		,
        agree.sms_status	,
        agree.bank_ret_code 	,
        agree.reason		,
        CONVERT(agree.single_max/100, decimal(15,2)) AS "single_max" 	,
        agree.day_max		,
        agree.month_max	,
        CONVERT(agree.sum_max/100, decimal(15,2)) AS "sum_max" ,
        agree.start_date	,
        date_format(agree.end_date, '%Y-%m-%d') end_date	,
        agree.create_time	,
        agree.update_time

    </sql>


    <select id="conditionQuery" resultType="com.xhnj.model.TWithholdAgree">
        select <include refid="withholdAgreeSql"/> from t_withhold_agree  agree where 1 = 1

        /*协议编号*/
        <if test="withholdAgree.agreementId != null and withholdAgree.agreementId != ''">
            and agreement_id = #{withholdAgree.agreementId,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.startDate !=null and withholdAgree.startDate != ''">
            and date_format(create_time, '%Y-%m-%d') <![CDATA[ >= ]]> str_to_date(#{withholdAgree.startDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>

        <if test="withholdAgree.endDate !=null and withholdAgree.endDate != ''">
            and date_format(create_time, '%Y-%m-%d') <![CDATA[ <= ]]> str_to_date(#{withholdAgree.endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>

        <if test="withholdAgree.customerName !=null and withholdAgree.customerName != ''">
            and customer_name like "%"#{withholdAgree.customerName,jdbcType=VARCHAR}"%"
        </if>

        <if test="withholdAgree.mobileNo !=null and withholdAgree.mobileNo != ''">
            and mobile_no = #{withholdAgree.mobileNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.cardNo !=null and withholdAgree.cardNo != ''">
            and card_no = #{withholdAgree.cardNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.certNo !=null and withholdAgree.certNo != ''">
            and cert_no = #{withholdAgree.certNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.bankCode !=null and withholdAgree.bankCode != ''">
            and bank_code = #{withholdAgree.bankCode,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.status !=null">
            and status = #{withholdAgree.status,jdbcType=INTEGER}
        </if>

        order by agree.create_time desc
    </select>

    <!--
        授权报告页面查询：查询成功
        查询逻辑：
        对相同的银行卡 和agreementID来说，判断最后一条记录是成功还是失败及取消，需要结合授权和取消表，确认最后一条记录。是成功还是失败
    -->
    <select id="selectSuccess" resultType="com.xhnj.model.TWithholdAgree">
        select <include refid="withholdAgreeSql"/> from t_withhold_agree agree
        where id in (
            select max(t.id)
            from t_withhold_agree_sms sms left join t_withhold_agree t on sms.agreement_id = t.agreement_id and sms.card_no = t.card_no

            /*协议编号*/
            <if test="withholdAgree.agreementId != null and withholdAgree.agreementId != ''">
                and t.agreement_id = #{withholdAgree.agreementId,jdbcType=VARCHAR}
            </if>

            <if test="withholdAgree.startDate !=null and withholdAgree.startDate != ''">
                and date_format(t.create_time, '%Y-%m-%d') <![CDATA[ >= ]]> str_to_date(#{withholdAgree.startDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
            </if>

            <if test="withholdAgree.endDate !=null and withholdAgree.endDate != ''">
                and date_format(t.create_time, '%Y-%m-%d') <![CDATA[ <= ]]> str_to_date(#{withholdAgree.endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
            </if>

            <if test="withholdAgree.customerName !=null and withholdAgree.customerName != ''">
                and t.customer_name like "%"#{withholdAgree.customerName,jdbcType=VARCHAR}"%"
            </if>

            <if test="withholdAgree.mobileNo !=null and withholdAgree.mobileNo != ''">
                and t.mobile_no = #{withholdAgree.mobileNo,jdbcType=VARCHAR}
            </if>

            <if test="withholdAgree.cardNo !=null and withholdAgree.cardNo != ''">
                and t.card_no = #{withholdAgree.cardNo,jdbcType=VARCHAR}
            </if>

            <if test="withholdAgree.certNo !=null and withholdAgree.certNo != ''">
                and t.cert_no = #{withholdAgree.certNo,jdbcType=VARCHAR}
            </if>

            <if test="withholdAgree.bankCode !=null and withholdAgree.bankCode != ''">
                and t.bank_code = #{withholdAgree.bankCode,jdbcType=VARCHAR}
            </if>

            <if test="withholdAgree.status !=null">
                and t.status = #{withholdAgree.status,jdbcType=INTEGER}
            </if>

            group by t.agreement_id, t.card_no
        )

    </select>

    <!--授权报告条件导出-->
    <select id="conditionQueryList" resultType="com.xhnj.model.TWithholdAgreeExcel">
        select <include refid="withholdAgreeSql"/> from t_withhold_agree  agree where
        id in
        <foreach collection = "list" item = "id" open = "(" close = ")" separator = "," >
            #{id, jdbcType=INTEGER}
        </foreach>


    </select>

    <!--查询短信发送未完成授权-->
    <select id="selectSmsIsNotCompleted" resultType="com.xhnj.model.TWithholdAgree">
        SELECT
            <include refid="withholdAgreeSql"/>
        FROM t_withhold_agree agree,  t_withhold_agree_sms sms
        where agree.bizserial_no = sms.bizserial_no

        <if test="withholdAgree.startDate !=null and withholdAgree.startDate != ''">
            and date_format(agree.start_date, '%Y-%m-%d') <![CDATA[ >= ]]> str_to_date(#{withholdAgree.startDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>

        <if test="withholdAgree.endDate !=null and withholdAgree.endDate != ''">
            and date_format(agree.end_date, '%Y-%m-%d') <![CDATA[ <= ]]> str_to_date(#{withholdAgree.endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>

        <if test="withholdAgree.customerName !=null and withholdAgree.customerName != ''">
            and agree.customer_name like "%"#{withholdAgree.customerName,jdbcType=VARCHAR}"%"
        </if>

        <if test="withholdAgree.mobileNo !=null and withholdAgree.mobileNo != ''">
            and agree.mobile_no = #{withholdAgree.mobileNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.cardNo !=null and withholdAgree.cardNo != ''">
            and agree.card_no = #{withholdAgree.cardNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.certNo !=null and withholdAgree.certNo != ''">
            and agree.cert_no = #{withholdAgree.certNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.bankCode !=null and withholdAgree.bankCode != ''">
            and agree.bank_code = #{withholdAgree.bankCode,jdbcType=VARCHAR}
        </if>
    </select>

    <!--查询最新一条数据-->
    <select id="selectLatestDate" resultType="com.xhnj.model.TWithholdAgree">
        SELECT
        <include refid="withholdAgreeSql"/>
        FROM t_withhold_agree agree where 1= 1

        <if test="withholdAgree.startDate !=null and withholdAgree.startDate != ''">
            and date_format(agree.start_date, '%Y-%m-%d') <![CDATA[ >= ]]> str_to_date(#{withholdAgree.startDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>

        <if test="withholdAgree.endDate !=null and withholdAgree.endDate != ''">
            and date_format(agree.end_date, '%Y-%m-%d') <![CDATA[ <= ]]> str_to_date(#{withholdAgree.endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>

        <if test="withholdAgree.customerName !=null and withholdAgree.customerName != ''">
            and agree.customer_name like "%"#{withholdAgree.customerName,jdbcType=VARCHAR}"%"
        </if>

        <if test="withholdAgree.mobileNo !=null and withholdAgree.mobileNo != ''">
            and agree.mobile_no = #{withholdAgree.mobileNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.cardNo !=null and withholdAgree.cardNo != ''">
            and agree.card_no = #{withholdAgree.cardNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.certNo !=null and withholdAgree.certNo != ''">
            and agree.cert_no = #{withholdAgree.certNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.bankCode !=null and withholdAgree.bankCode != ''">
            and agree.bank_code = #{withholdAgree.bankCode,jdbcType=VARCHAR}
        </if>

        order by agree.create_time desc
    </select>
    <select id="selectBankcode" resultType="com.xhnj.model.TWithholdAgree">
        select 1 from  t_bank_code_mapp where bank_code=#{bankCode}
    </select>
    <select id="selectList" resultType="com.xhnj.model.TWithholdAgree">
        select <include refid="withholdAgreeSql"/> from t_withhold_agree  agree where 1 = 1

        /*协议编号*/
        <if test="withholdAgree.agreementId != null and withholdAgree.agreementId != ''">
            and agreement_id = #{withholdAgree.agreementId,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.startDate !=null and withholdAgree.startDate != ''">
            and date_format(create_time, '%Y-%m-%d') <![CDATA[ >= ]]> str_to_date(#{withholdAgree.startDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>

        <if test="withholdAgree.endDate !=null and withholdAgree.endDate != ''">
            and date_format(create_time, '%Y-%m-%d') <![CDATA[ <= ]]> str_to_date(#{withholdAgree.endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>

        <if test="withholdAgree.customerName !=null and withholdAgree.customerName != ''">
            and customer_name like "%"#{withholdAgree.customerName,jdbcType=VARCHAR}"%"
        </if>

        <if test="withholdAgree.mobileNo !=null and withholdAgree.mobileNo != ''">
            and mobile_no = #{withholdAgree.mobileNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.cardNo !=null and withholdAgree.cardNo != ''">
            and card_no = #{withholdAgree.cardNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.certNo !=null and withholdAgree.certNo != ''">
            and cert_no = #{withholdAgree.certNo,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.bankCode !=null and withholdAgree.bankCode != ''">
            and bank_code = #{withholdAgree.bankCode,jdbcType=VARCHAR}
        </if>

        <if test="withholdAgree.status !=null">
            and status = #{withholdAgree.status,jdbcType=INTEGER}
        </if>
    </select>


</mapper>